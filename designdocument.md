# ChatGPT LightWeight Terminal (CLWT) 設計書・技術要件仕様書

## 1. はじめに

本ドキュメントは、ChatGPT LightWeight Terminal (CLWT) （旧称: Akutsu Proxy Terminal）のシステム設計および技術要件をまとめたものである。CLWTは、ChatGPTとのチャット履歴をローカル環境で効率的に管理し、UI上での操作性を向上させることを目的としたデスクトップアプリケーションである。特に、コードブロックの改行やインデントの保持、チャット履歴の同期機能、および使いやすいユーザインターフェースの提供に重点を置いている。
本アプリケーションは、WindowsおよびLinux (Wayland/X11) の両OS環境で動作するクロスプラットフォーム設計となっている。

## 2. システム概要

CLWTは、PythonベースのGUIアプリケーションであり、バックエンドにPlaywrightを使用してWebブラウザ（ChatGPT）を自動操作する。ユーザは専用のGUIを通じてChatGPTと対話し、履歴の閲覧や管理を行うことができる。

## 3. システムアーキテクチャ

システムは以下の主要コンポーネントで構成される。

### 3.1 フロントエンド
- **フレームワーク**: `PyQt6`
- **主な機能**:
  - メインウィンドウの表示
  - チャットログの表示（行番号付き、シンタックスハイライト（簡易））
  - ユーザ入力の受付
  - ツールバーによる操作（キャッシュクリア、リロード、履歴同期など）
  - システムログの表示

### 3.2 バックエンド
- **エンジン**: `Playwright` (Python API) + Chromium
- **主な機能**:
  - ChatGPTへのログインセッション管理（永続化）
  - チャット履歴のスクレイピング（DOM操作による完全なテキスト抽出）
  - ユーザ入力の自動送信
  - レスポンスのリアルタイム取得（ストリーミング対応）
  - 履歴リスト（サイドバー）の取得

## 4. ディレクトリ構造

システムのディレクトリ構成は、実行ファイル `ChatgptLightWeightTerminal.py` が配置されたディレクトリをルートとして動的に解決される。

- `(AppRoot)/` (アプリケーションルート)
  - `ChatgptLightWeightTerminal.py`: アプリケーション本体。
  - `applog/session/`: Playwrightのブラウザセッション情報（Cookie、LocalStorage等）を保存するディレクトリ。再起動後もログイン状態を維持するために使用。
  - `tmp1/`: チャット履歴の解析済みJSONデータをキャッシュとして保存するディレクトリ。
  - `log1/`: システムの動作ログファイルを保存するディレクトリ。7日経過した古いログは自動的に削除される。
  - `venv/`: Python仮想環境ディレクトリ。

## 5. 機能要件

### 5.1 チャット機能
- **メッセージ送信**: ユーザが入力したテキストをChatGPTに送信し、AIからの応答を表示する。
- **ストリーミング表示**: AIの生成中の回答をリアルタイムで画面に表示する。
- **コードブロック表示**:
  - コードブロックの開始と終了を明確に区別して表示する。
  - コード内の改行やインデントを崩さずに表示する（`pre`タグの内容を正確に抽出）。
  - 言語名を表示する。
- **行番号表示**:
  - チャットログに行番号を表示する。
  - 発言者（ユーザ、AI、システム）に応じて行番号の色を変更する。
    - ユーザ: 薄い緑 (`#aaffaa`)
    - AI: 薄い青 (`#aaaaff`)
    - システム/その他: グレー (`#888888`)

### 5.2 履歴管理機能
- **履歴同期 (サイドバー)**: ChatGPTのサイドバーから最近のチャット履歴（タイトルとURL）を取得し、プルダウンメニューに反映する。
- **履歴読み込み**:
  - URL指定またはプルダウン選択により、過去のチャット履歴を読み込む。
  - ローカルキャッシュ（`tmp1/`）が存在する場合はそれを優先表示し、バックグラウンドでWebページとの同期を行う（差分更新）。
- **DOM一括構築・一括抽出**:
  - ブラウザ上のDOM要素から直接テキストとコードを抽出することで、表示崩れを防ぐ。
  - `pre`タグ内のコードは、コピーボタンなどのノイズを除去した上で抽出する。

### 5.3 キャッシュ・データ管理機能
- **キャッシュ保存**: 取得したチャット履歴をチャットIDごとにJSONファイルとして保存する。
- **キャッシュクリア**: 全てのキャッシュファイルを削除し、履歴リストを再取得する。
- **削除リロード**: 現在のチャットのキャッシュを削除し、Webページから強制的に再取得する。
- **単純リロード**: キャッシュは保持したまま、Webページをリロードする。
- **自動クリーンアップ**: 起動時に7日以上前の古いログファイルやキャッシュファイルを削除する。

### 5.4 ログ機能
- **システムログ**: アプリケーションの動作状況（ブラウザ接続、データ取得、エラー等）を画面下部のログエリアに表示する。
- **ログファイル出力**: 詳細なログを `log1/` ディレクトリにファイルとして出力する。

### 5.5 入力モード切替
- **ブラウザモード**: `Enter`で送信、`Shift+Enter`で改行。
- **メモ帳モード**: `Enter`で改行、ボタンクリックで送信。
- ツールバー上のコンボボックスで切り替え可能。

## 6. 非機能要件

### 6.1 パフォーマンス
- **高速同期**: キャッシュを活用し、画面表示までの時間を短縮する。
- **遅延ロード対策**: チャット履歴が長い場合、スクロールして全ての要素が読み込まれるのを待機してから抽出を行う。

### 6.2 信頼性
- **再接続機能**: ブラウザとの接続が切断された場合、自動的に再起動を試みる。
- **エラーハンドリング**: スクレイピング中の例外やタイムアウトを適切に捕捉し、システムログに記録する。

### 6.3 保守性
- **ログローテーション**: 古いログファイルを自動削除し、ディスク容量を圧迫しないようにする。

## 7. UI/UX設計

### 7.1 メインウィンドウ
- **ツールバー (上部)**:
  - キャッシュクリア、リロード、履歴取込、移動ボタン。
  - 履歴選択用コンボボックス。
- **チャットエリア (中央)**:
  - 行番号付きのテキストエディタコンポーネントを使用。
  - 読み取り専用。
- **入力エリア (下部)**:
  - 入力モード切替、警告メッセージを表示するツールバー。
  - テキスト入力ボックス。
  - 送信ボタン。
- **システムログエリア (最下部)**:
  - 折りたたみ可能なログ表示エリア。

### 7.2 デザイン
- **テーマ**: ダークテーマ（背景色 `#1e1e1e`、文字色 `#d4d4d4`）を採用し、長時間使用時の目の負担を軽減する。
- **配色**:
  - 入力ボックス: 少し明るいグレー (`#2d2d2d`)。
  - ボタン: 青色 (`#007acc`) を基調とし、ホバー時に明るくする。
  - 警告メッセージ: オレンジ色 (`#ffaa00`)。

## 8. 技術スタック詳細

- **言語**: Python 3
- **GUIライブラリ**: PyQt6
- **ブラウザ操作**: Playwright (Sync API)
- **ブラウザ**: Chromium (Headless False, `--no-sandbox`, `--disable-blink-features=AutomationControlled`)
- **環境**: Linux (Wayland/XCB対応) および Windows 10/11

## 9. 運用手順

### 9.1 初回セットアップ
OSに応じたセットアップスクリプトを実行し、環境構築を行う。

- **Linux**: `bash setup_clwt_env.bash` を実行。
- **Windows**: `setup_clwt_env.bat` を実行。
  - これにより `venv` の作成、ライブラリのインストール、Chromiumのセットアップが自動で行われる。

### 9.2 アプリケーションの起動
仮想環境を有効化した状態で、Pythonスクリプトを実行する。

```bash
# Linux
source venv/bin/activate
python ChatgptLightWeightTerminal.py
```

```bat
rem Windows
call venv\Scripts\activate
python ChatgptLightWeightTerminal.py
```
